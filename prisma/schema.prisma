// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["metrics", "tracing"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------------------------
// Enums
// -----------------------------------------------------------------------------

/// Accounting account classification.
/// Used for:
/// - Financial statements (Balance Sheet, P&L)
/// - Debit/Credit behavior interpretation
/// - AI semantic grounding
enum AccountType {
  /// Assets: resources owned by the company (Cash, Bank, Inventory)
  ASSET

  /// Liabilities: obligations owed to third parties
  LIABILITY

  /// Equity: shareholders' or owners' equity
  EQUITY

  /// Revenues: income generated by operations
  REVENUE

  /// Expenses and costs
  EXPENSE
}

/// Lifecycle state of an accounting journal entry.
enum EntryStatus {
  /// Entry is being prepared and does not affect balances
  DRAFT

  /// Official posted entry; immutable and balance-affecting
  POSTED

  /// Entry has been voided
  VOIDED
}

enum EntrySource {
  /// Entry created manually by a user
  MANUAL

  /// Entry created by the system (e.g., automatic posting)
  SYSTEM

  /// Entry created from an external source (e.g., import)
  IMPORT

  /// Suggested or generated by AI (never auto-posted)
  AI
}

/// Indicates whether a line is a debit or a credit.
enum DebitCredit {
  DEBIT
  CREDIT
}

// -----------------------------------------------------------------------------
// Models
// -----------------------------------------------------------------------------

/// Represents a distinct business unit or organization.
model Tenant {
  id                 String   @id @default(uuid())
  name               String
  slug               String   @unique
  fiscalYearEndMonth Int // 1-12
  reportingCurrency  String   @db.VarChar(3) // ISO 4217 Code
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  accounts       Account[]
  costCenters    CostCenter[]
  journalEntries JournalEntry[]
}

/// A Chart of Accounts element.
model Account {
  id       String      @id @default(uuid())
  tenantId String
  code     String
  name     String
  type     AccountType

  // Hierarchy (Self-referencing)
  parentId String?
  parent   Account?  @relation("AccountHierarchy", fields: [parentId], references: [id])
  children Account[] @relation("AccountHierarchy")

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant            Tenant             @relation(fields: [tenantId], references: [id])
  journalEntryLines JournalEntryLine[]

  @@unique([tenantId, code])
  @@index([tenantId])
}

/// Represents a department or project for allocation.
model CostCenter {
  id       String  @id @default(uuid())
  tenantId String
  code     String
  name     String
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant            Tenant             @relation(fields: [tenantId], references: [id])
  journalEntryLines JournalEntryLine[]

  @@unique([tenantId, code])
  @@index([tenantId])
}

/// The Aggregate Root for financial transactions.
model JournalEntry {
  id          String  @id @default(uuid())
  tenantId    String
  description String
  reference   String? // External reference number

  // Dates
  transactionDate DateTime // When it happened
  postingDate     DateTime // When it impacts the books

  // Status & Versioning
  status  EntryStatus @default(DRAFT)
  version Int         @default(1) // Optimistic Concurrency Control

  // Audit Fields
  createdById String?
  postedById  String?
  documentUrl String? // URL to supporting evidence (PDF, Image, etc.)
  source      EntrySource @default(MANUAL)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant             @relation(fields: [tenantId], references: [id])
  lines  JournalEntryLine[]

  @@index([tenantId, postingDate])
  @@index([tenantId, transactionDate])
}

/// Individual line items within a Journal Entry.
model JournalEntryLine {
  id             String  @id @default(uuid())
  journalEntryId String
  accountId      String
  costCenterId   String?

  description String?
  direction   DebitCredit
  amount      Decimal     @db.Decimal(18, 2)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  journalEntry JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account      Account      @relation(fields: [accountId], references: [id])
  costCenter   CostCenter?  @relation(fields: [costCenterId], references: [id])

  @@index([journalEntryId])
  @@index([accountId])
}
